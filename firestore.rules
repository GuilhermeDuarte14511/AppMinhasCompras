rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isString(v, min, max) {
      return v is string && v.size() >= min && v.size() <= max;
    }

    function isDateString(v) {
      return v is string && v.size() >= 10 && v.size() <= 40;
    }

    function isDateLike(v) {
      return v is timestamp || isDateString(v);
    }

    function isNumber(v) {
      return v is int || v is float;
    }

    function isNumberOrNull(v) {
      return v == null || isNumber(v);
    }

    function validTheme(v) {
      return v == null || v in ['light', 'dark'];
    }

    function validProvider(v) {
      return v == null || v in ['password', 'google.com'];
    }

    function validCategory(v) {
      return v in [
        'produce',
        'bakery',
        'meat',
        'seafood',
        'dairy',
        'eggs',
        'grains_pasta',
        'frozen',
        'snacks',
        'sweets',
        'condiments',
        'grocery',
        'beverages',
        'cleaning',
        'personal_care',
        'baby',
        'pet',
        'other'
      ];
    }

    function validReminder(reminder) {
      return reminder == null || (
        reminder is map &&
        reminder.keys().hasOnly(['scheduledAt']) &&
        reminder.keys().hasAll(['scheduledAt']) &&
        isDateLike(reminder.scheduledAt)
      );
    }

    function validUserRootCommon(d) {
      return d.keys().hasOnly([
          'displayName',
          'email',
          'photoUrl',
          'provider',
          'createdAt',
          'updatedAt',
          'themeMode',
          'isOnboardingCompleted'
        ]) &&
        d.keys().hasAny(['updatedAt']) &&
        (!d.keys().hasAny(['displayName']) || isString(d.displayName, 1, 80)) &&
        (!d.keys().hasAny(['email']) || isString(d.email, 3, 200)) &&
        (!d.keys().hasAny(['photoUrl']) ||
          d.photoUrl == null ||
          isString(d.photoUrl, 5, 2000)) &&
        (!d.keys().hasAny(['provider']) || validProvider(d.provider)) &&
        (!d.keys().hasAny(['createdAt']) || isDateLike(d.createdAt)) &&
        isDateLike(d.updatedAt) &&
        (!d.keys().hasAny(['themeMode']) || validTheme(d.themeMode)) &&
        (!d.keys().hasAny(['isOnboardingCompleted']) ||
          d.isOnboardingCompleted is bool);
    }

    function validUserRootCreate() {
      let d = request.resource.data;
      return validUserRootCommon(d);
    }

    function validUserRootUpdate() {
      let d = request.resource.data;
      return validUserRootCommon(d) &&
        (
          !resource.data.keys().hasAny(['createdAt']) ||
          (
            d.keys().hasAny(['createdAt']) &&
            d.createdAt == resource.data.createdAt
          )
        );
    }

    function validListDoc(listId) {
      let d = request.resource.data;
      return d.keys().hasOnly([
          'id',
          'name',
          'createdAt',
          'updatedAt',
          'items',
          'budget',
          'reminder',
          'paymentBalances',
          'isClosed',
          'closedAt'
        ]) &&
        d.keys().hasAll([
          'id',
          'name',
          'createdAt',
          'updatedAt',
          'items',
          'budget',
          'reminder',
          'paymentBalances',
          'isClosed',
          'closedAt'
        ]) &&
        d.id == listId &&
        isString(d.name, 1, 120) &&
        isDateLike(d.createdAt) &&
        isDateLike(d.updatedAt) &&
        d.items is list &&
        d.items.size() <= 2000 &&
        isNumberOrNull(d.budget) &&
        validReminder(d.reminder) &&
        d.paymentBalances is list &&
        d.paymentBalances.size() <= 30 &&
        d.isClosed is bool &&
        (d.closedAt == null || isDateLike(d.closedAt));
    }

    function validHistoryDoc(historyId) {
      let d = request.resource.data;
      return d.keys().hasOnly([
          'id',
          'listId',
          'listName',
          'closedAt',
          'items',
          'budget',
          'paymentBalances'
        ]) &&
        d.keys().hasAll([
          'id',
          'listId',
          'listName',
          'closedAt',
          'items',
          'budget',
          'paymentBalances'
        ]) &&
        d.id == historyId &&
        isString(d.listId, 1, 120) &&
        isString(d.listName, 1, 120) &&
        isDateLike(d.closedAt) &&
        d.items is list &&
        d.items.size() <= 3000 &&
        isNumberOrNull(d.budget) &&
        d.paymentBalances is list &&
        d.paymentBalances.size() <= 30;
    }

    function validCatalogDoc(productId) {
      let d = request.resource.data;
      return d.keys().hasOnly([
          'id',
          'name',
          'category',
          'unitPrice',
          'barcode',
          'usageCount',
          'updatedAt',
          'priceHistory'
        ]) &&
        d.keys().hasAll([
          'id',
          'name',
          'category',
          'unitPrice',
          'barcode',
          'usageCount',
          'updatedAt',
          'priceHistory'
        ]) &&
        d.id == productId &&
        isString(d.name, 1, 180) &&
        validCategory(d.category) &&
        isNumberOrNull(d.unitPrice) &&
        (d.barcode == null || isString(d.barcode, 8, 64)) &&
        d.usageCount is int &&
        d.usageCount >= 0 &&
        isDateLike(d.updatedAt) &&
        d.priceHistory is list &&
        d.priceHistory.size() <= 500;
    }

    function validSettingsDoc(docId) {
      let d = request.resource.data;
      return docId == 'app' &&
        d.keys().hasOnly(['themeMode', 'updatedAt']) &&
        d.keys().hasAll(['themeMode', 'updatedAt']) &&
        validTheme(d.themeMode) &&
        isDateLike(d.updatedAt);
    }

    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create: if isOwner(uid) && validUserRootCreate();
      allow update: if isOwner(uid) && validUserRootUpdate();
      allow delete: if isOwner(uid);

      match /lists/{listId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && validListDoc(listId);
        allow delete: if isOwner(uid);
      }

      match /history/{historyId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && validHistoryDoc(historyId);
        allow delete: if isOwner(uid);
      }

      match /catalog/{productId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && validCatalogDoc(productId);
        allow delete: if isOwner(uid);
      }

      match /settings/{docId} {
        allow read: if isOwner(uid);
        allow create, update: if isOwner(uid) && validSettingsDoc(docId);
        allow delete: if isOwner(uid);
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
